generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String
  role          UserRole  @default(ASSISTANT_COACH)
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts        Account[]
  sessions        Session[]
  announcements   Announcement[]
  messages        Message[]
  sentInvitations Invitation[] @relation("InvitationSender")
  teamMemberships TeamMember[]
  deviceTokens    DeviceToken[]

  @@map("users")
}

enum UserRole {
  HEAD_COACH
  ASSISTANT_COACH
  TEAM_MANAGER
  PARENT
  PLAYER
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Player {
  id             String   @id @default(cuid())
  firstName      String
  lastName       String
  jerseyNumber   Int
  photo          String?
  positions      String[]
  bats           String
  throws         String
  graduationYear Int
  birthDate      DateTime?
  parentName     String?
  parentPhone    String?
  parentEmail    String?
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  stats              PlayerStat[]
  gameStats          GamePlayerStat[]
  customMetrics      CustomMetric[]
  performanceMetrics PerformanceMetric[]

  @@map("players")
}

// Performance metrics with history tracking (exit velo, pulldown velo, 60 yard sprint)
model PerformanceMetric {
  id        String            @id @default(cuid())
  playerId  String
  type      PerformanceType
  value     Float
  unit      String            // mph, seconds, etc.
  date      DateTime          @default(now())
  notes     String?
  createdAt DateTime          @default(now())

  player    Player            @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([playerId, type, date])
  @@map("performance_metrics")
}

enum PerformanceType {
  EXIT_VELOCITY
  PULLDOWN_VELOCITY
  SIXTY_YARD_SPRINT
}

model PlayerStat {
  id       String @id @default(cuid())
  playerId String
  season   String

  // Hitting stats
  ab       Int    @default(0)
  h        Int    @default(0)
  doubles  Int    @default(0)
  triples  Int    @default(0)
  hr       Int    @default(0)
  rbi      Int    @default(0)
  bb       Int    @default(0)
  k        Int    @default(0)

  // Pitching stats
  ip       Float  @default(0)
  pitchingH Int   @default(0)
  r        Int    @default(0)
  er       Int    @default(0)
  pitchingBB Int  @default(0)
  pitchingK Int   @default(0)

  // Fielding stats
  po       Int    @default(0)
  a        Int    @default(0)
  e        Int    @default(0)

  player   Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([playerId, season])
  @@map("player_stats")
}

model CustomMetric {
  id        String   @id @default(cuid())
  playerId  String
  name      String
  value     String
  date      DateTime @default(now())

  player    Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@map("custom_metrics")
}

model Event {
  id             String         @id @default(cuid())
  title          String
  type           EventType
  start          DateTime
  end            DateTime
  allDay         Boolean        @default(false)
  location       String?
  locationUrl    String?
  description    String?
  color          String?
  recurring      Boolean        @default(false)
  rrule          String?
  opponent       String?
  governingBody  GoverningBody? @default(NA)
  requiresTravel Boolean        @default(false)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  rsvps          RSVP[]
  games          Game[]
  tournament     Tournament?    @relation(fields: [tournamentId], references: [id])
  tournamentId   String?

  @@map("events")
}

enum EventType {
  PRACTICE
  GAME
  TOURNAMENT
  TEAM_MEETING
  FUNDRAISER
  OFF_DAY
  INDIVIDUAL_LESSON
}

enum GoverningBody {
  NA
  PBR
  USSSA
  JP_SPORTS
  PG
  GAMEDAY
}

model RSVP {
  id        String     @id @default(cuid())
  eventId   String
  playerName String
  status    RSVPStatus
  createdAt DateTime   @default(now())

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, playerName])
  @@map("rsvps")
}

enum RSVPStatus {
  YES
  NO
  MAYBE
}

model Game {
  id          String   @id @default(cuid())
  eventId     String?
  opponent    String
  homeAway    String
  score       String?
  opponentScore String?
  result      String?
  notes       String?
  date        DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  event       Event?   @relation(fields: [eventId], references: [id])
  playerStats GamePlayerStat[]

  @@map("games")
}

model GamePlayerStat {
  id       String @id @default(cuid())
  gameId   String
  playerId String

  // Hitting
  ab       Int    @default(0)
  h        Int    @default(0)
  doubles  Int    @default(0)
  triples  Int    @default(0)
  hr       Int    @default(0)
  rbi      Int    @default(0)
  bb       Int    @default(0)
  k        Int    @default(0)

  // Pitching
  ip       Float  @default(0)
  pitchingH Int   @default(0)
  r        Int    @default(0)
  er       Int    @default(0)
  pitchingBB Int  @default(0)
  pitchingK Int   @default(0)

  // Fielding
  po       Int    @default(0)
  a        Int    @default(0)
  e        Int    @default(0)

  game     Game   @relation(fields: [gameId], references: [id], onDelete: Cascade)
  player   Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([gameId, playerId])
  @@map("game_player_stats")
}

model Tournament {
  id              String   @id @default(cuid())
  name            String
  startDate       DateTime
  endDate         DateTime
  location        String?
  entryFee        Float?
  hotelName       String?
  hotelLink       String?
  hotelDeadline   DateTime?
  perDiem         Float?
  budget          Float?
  notes           String?
  itinerary       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  events          Event[]
  carpools        Carpool[]
  expenses        TournamentExpense[]

  @@map("tournaments")
}

model Carpool {
  id           String  @id @default(cuid())
  tournamentId String
  driverName   String
  driverPhone  String?
  seatsOffered Int
  passengers   String[]

  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)

  @@map("carpools")
}

model TournamentExpense {
  id           String   @id @default(cuid())
  tournamentId String
  category     String
  description  String
  amount       Float
  date         DateTime @default(now())

  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)

  @@map("tournament_expenses")
}

model Document {
  id          String       @id @default(cuid())
  name        String
  type        DocumentType
  fileUrl     String
  fileSize    Int
  mimeType    String
  uploadedBy  String?
  playerId    String?
  description String?
  encrypted   Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@map("documents")
}

enum DocumentType {
  INSURANCE
  BIRTH_CERTIFICATE
  MEDICAL_FORM
  ROSTER
  OTHER
}

model Announcement {
  id        String   @id @default(cuid())
  title     String
  content   String
  priority  Priority @default(NORMAL)
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  author    User     @relation(fields: [authorId], references: [id])

  @@map("announcements")
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model Message {
  id        String   @id @default(cuid())
  subject   String
  body      String
  senderId  String
  recipients String[]
  sentAt    DateTime @default(now())

  sender    User     @relation(fields: [senderId], references: [id])

  @@map("messages")
}

model Team {
  id        String   @id @default(cuid())
  name      String   @unique
  season    String
  joinCode  String   @unique @default(cuid())
  logoUrl   String?
  colors    String[]
  ageGroup  String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members   TeamMember[]

  @@index([joinCode])
  @@map("teams")
}

model TeamMember {
  id        String   @id @default(cuid())
  teamId    String
  userId    String
  role      UserRole
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([userId])
  @@index([teamId])
  @@map("team_members")
}

// DEPRECATED: Keeping for backward compatibility during migration
model TeamConfig {
  id        String   @id @default(cuid())
  teamName  String
  season    String
  logoUrl   String?
  colors    String[]
  ageGroup  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("team_config")
}

model Invitation {
  id         String           @id @default(cuid())
  email      String
  role       UserRole
  token      String           @unique @default(cuid())
  status     InvitationStatus @default(PENDING)
  expiresAt  DateTime
  invitedBy  String
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  inviter    User             @relation("InvitationSender", fields: [invitedBy], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([token])
  @@map("invitations")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

model Workout {
  id               String           @id @default(cuid())
  title            String
  frequency        WorkoutFrequency
  ageMin           Int?
  ageMax           Int?
  duration         Int              // Session duration in minutes
  programDuration  Int?             // How long the program runs
  programDurationUnit String?       // Unit: DAY, WEEK, MONTH
  focus            WorkoutFocus[]
  description      String?
  active           Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  sessions    WorkoutSession[]

  @@map("workouts")
}

model WorkoutSession {
  id          String   @id @default(cuid())
  workoutId   String
  date        DateTime
  notes       String?
  completed   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workout     Workout  @relation(fields: [workoutId], references: [id], onDelete: Cascade)

  @@map("workout_sessions")
}

enum WorkoutFrequency {
  DAILY
  EVERY_OTHER_DAY
  TWICE_WEEKLY
  WEEKLY
  BIWEEKLY
  MONTHLY
  CUSTOM
}

enum WorkoutFocus {
  HITTING
  PITCHING
  FIELDING
  BASE_RUNNING
  CONDITIONING
  STRENGTH
  AGILITY
  MENTAL
  TEAM_BUILDING
}

// Push notification device tokens
model DeviceToken {
  id        String   @id @default(cuid())
  userId    String
  token     String
  platform  String   // "ios" or "android"
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, token])
  @@index([userId])
  @@index([token])
  @@map("device_tokens")
}

// Scheduled notification jobs for tracking
model ScheduledNotification {
  id            String   @id @default(cuid())
  type          String   // "event_reminder", "tournament_travel", "announcement"
  referenceId   String   // eventId, tournamentId, or announcementId
  scheduledFor  DateTime
  sent          Boolean  @default(false)
  sentAt        DateTime?
  createdAt     DateTime @default(now())

  @@index([scheduledFor, sent])
  @@index([referenceId])
  @@map("scheduled_notifications")
}
